---
title: "HDT2"
author: "Marisa Montoya, Majo Morales, Luis Garcia y Juanfer De Leon"
date: "8/2/2021"
output: html_document
---
##Analisis exploratorio

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("xts")
# install.packages("forecast")
# install.packages("fUnitRoots")
# install.packages("ggfortify")
# install.packages("tsbox")
library(epiDisplay)
library(forecast)
library(tseries)
library(fUnitRoots)
library(ggfortify)
library("xts")
library(tsbox)


setwd('C:/Users/Marisa Montoya}/lab2-DS')
consumo <- read.csv("DatosConsumoCombustibles.csv")
importacion <- read.csv("DatosImportacionCombustibles.csv")


```

###Consumo Dataset
```{r Graficas1 consumo, echo=FALSE}
str(consumo)
```

Podemos ver que todas las variables tratadas en las datasets son variables cuantitativas, por lo que haremos histogramas de las variables. 

```{r hist consumo, echo=FALSE}
hist(x= consumo$X, main=paste("Histograma de X"))
hist(x= consumo$Anio, main=paste("Histograma de Anio"))
tab1(consumo$Anio, sort.group = "decreasing")
hist(x= consumo$Mes, main=paste("Histograma de Mes"))
hist(x= consumo$GasolinaSuper, main=paste("Histograma de GasolinaSuper"))
hist(x= consumo$GasolinaRegular, main=paste("Histograma de GasolinaRegular"))
hist(x= consumo$TotalGasolinas, main=paste("Histograma de TotalGasolinas"))
hist(x= consumo$Diesel, main=paste("Histograma de Diesel"))
hist(x= consumo$DieselLS, main=paste("Histograma de DieselLS"))
hist(x= consumo$DieselULS, main=paste("Histograma de DieselULS"))
hist(x= consumo$TotalDiesel, main=paste("Histograma de TotalDiesel"))
hist(x= consumo$GLP, main=paste("Histograma de GLP"))
hist(x= consumo$GasolinaAviacion, main=paste("Histograma de GasolinaAviacion"))
hist(x= consumo$Kerosina, main=paste("Histograma de Kerosina"))
hist(x= consumo$TurboJet, main=paste("Histograma de TurboJet"))
hist(x= consumo$Bunker, main=paste("Histograma de Bunker"))
hist(x= consumo$Asfalto, main=paste("Histograma de Asfalto"))
hist(x= consumo$PetCoke, main=paste("Histograma de PetCoke"))
hist(x= consumo$AceitesLubricantes, main=paste("Histograma de AceitesLubricantes"))
hist(x= consumo$GrasasLubricantes, main=paste("Histograma de GrasasLubricantes"))
hist(x= consumo$Solventes, main=paste("Histograma de Solventes"))
hist(x= consumo$Naftas, main=paste("Histograma de Naftas"))
hist(x= consumo$Ceras, main=paste("Histograma de Ceras"))
hist(x= consumo$CrudoNacional, main=paste("Histograma de CrudoNacional"))
hist(x= consumo$Butano, main=paste("Histograma de Butano"))
hist(x= consumo$Orimulsion, main=paste("Histograma de Orimulsion"))
hist(x= consumo$MezclasOleosas, main=paste("Histograma de MezclasOleosas"))
hist(x= consumo$Total, main=paste("Histograma de Total"))

```

Variable X: no sigue distribución normal, y es lo esperado ya que X es una variable diferente para los datos, como un ID. 

Variable Anio: No sigue una distribucion normal tampoco, pero nos muestra que hay una frecuencia mayor en los primeros años comenzando en 2000, luego las frecuencias en los demas años son similares hasta 2021, cuando los datos son muy pocos. 

Variable mes: No sigue una distribución normal tampoco.

Variable Gasolina Super: No sigue una distribución normal. 

Variable Gasolina Regular: No sigue una distribución normal. 

Variable Gasolina Diesel: Si sigue una distribución normal, por lo que pueda que tenga un comportamiento peculiar en el estudio de las series lineales. 

####Cruce de variables 
Al estar trabajando con las variables de gasolina, en los cruces de variables los haremos siempre con las variables de gasolinaSuper, Regular y Diesel.

```{r cruce de variables, echo=FALSE}
plot(y=consumo$GasolinaSuper,x=consumo$Anio,ylab="Gasolina Super", xlab="Anio")

```
De este cruce de variables podemos ver que puede que exista un tipo de tendencia, que con los años, el consumo de gasolina super creció con los años. 

```{r echo=FALSE}
plot(y=consumo$GasolinaRegular,x=consumo$Anio,ylab="Gasolina Regular", xlab="Anio")
plot(y=consumo$TotalDiesel,x=consumo$Anio,ylab="Gasolina Diesel", xlab="Anio")
```
Podemos ver que lo mismo sucedió con gasolina Regular y los años, pero otra vez, es la diesel la que tiene un comportamiento irregular. 

Ahora vamos a hacer el cruce de variables pero con meses.
```{r}
plot(y=consumo$GasolinaSuper,x=consumo$Mes,ylab="Gasolina Super", xlab="Mes")
plot(y=consumo$GasolinaRegular,x=consumo$Mes,ylab="Gasolina Regular", xlab="Mes")
plot(y=consumo$TotalDiesel,x=consumo$Mes,ylab="Gasolina Diesel", xlab="Mes")
```

Ahora vemos que las variables se comportan de una manera aleatoria conforme a los meses del año. Ya sea cualquier tipo de las gasolinas tratadas. 

Para comenzar con el analisis de series de tiempo nos encontramos con la necesidad de unir la columna de mes y anio en una sola columna en formato de fecha, luego crear diferentes data frames para los 3 tipos de gasolinas para hacer una linea del tiempo de cada una. 
```{r Serie, echo=FALSE}
consumo$Dia <- 1
consumo$Date <- as.Date(with(consumo, paste(Anio, Mes, Dia,sep="-")), "%Y-%m-%d")

cantSuper <- c(consumo$GasolinaSuper)
superDate <- c(consumo$Date)
consumoSuper <- data.frame(cantSuper,superDate)

cantRegular <- c(consumo$GasolinaRegular)
regularDate <- c(consumo$Date)
consumoRegular <- data.frame(cantRegular,regularDate)

cantDiesel <- c(consumo$TotalDiesel)
dieselDate <- c(consumo$Date)
consumoDiesel <- data.frame(cantDiesel,dieselDate)

```

####Linea de tiempo para consumo de gasolina super
Primero se convierte el data frame en una serie de tiempo. Luego podemos observar el inicio, fin, frecuencia y vista de la linea del tiempo.
```{r echo=FALSE}
consumoGS_ts <- xts(consumoSuper$cantSuper, consumoSuper$superDate) 
consumoGS_ts <-ts_ts(consumoGS_ts)
train <- head(consumoGS_ts, round(length(consumoGS_ts) * 0.7))
h <- length(consumoGS_ts) - length(train)
test <- tail(consumoGS_ts, h)
#Saber cuando empieza la serie y cuando termina
start(consumoGS_ts)
end(consumoGS_ts)
#Saber la frecuencia de la serie
frequency(consumoGS_ts)
#Ver el grÃ¡fico de la serie
plot(consumoGS_ts);

```
De esta linea podemos ver a primera vista que posee una tendencia a crecer, y que hay momentos en la linea de tiempo que hace que las varianzas tambien se vean afectadas y sean diferentes entre si. Podemos ver que se trata de una serie con frecuencia anual donde hay datos de todos los meses desde enero de 2000 hasta mayo del 2021.Como se puede ver la cantidad de galones vendidos va aumentando a medida que pasan los años.

#####Descomposicion de la serie
```{r echo=FALSE}
dec.GS<-decompose(consumoGS_ts)
plot(dec.GS)
```

Podemos observar una serie con tendencia a aumentar, que no es estacionaria en varianza, y además tiene estacionalidad.

Ahora vemos los datos de inicio y fin del train y del test
```{r echo=FALSE}
#Saber cuando empieza la serie y cuando termina
start(train)
end(train)
start(test)
end(test)
```


#####Estimar los parámetros del modelo.
Cómo no es estacionaria en varianza le haremos una transformación logaritmica para hacerla constante en varianza.
```{r include=FALSE}
logGS <- log(train)
lambda <- BoxCox.lambda(train)
boxcoxGS<-BoxCox(train,lambda)
```

Veremos si logramos estacionarizar la serie con esta transformación:

```{r echo=FALSE}
plot(decompose(logGS))
plot(logGS)
```
Podemos observar que las varianzas si se pudieron hacer mas constantes, sin embargo, se pueden observar picos de varianza desiguales, lo cual puede ser un problema y concreta que no se pudo estacionarizar en varianza en su totalidad.

Por lo que ahora trataremos de quitar la tendencia y estacionarizar en normalidad.
```{r echo=FALSE}
adfTest(train)
unitrootTest(train)

```
Ambas pruebas de Dickey-Fuller Test nos demuestra que p es mayor a 0.05 por lo que no podemos rechazar Ho, y por ende, asumir que no hay raices unitarias. Por lo que la serie de tiempo no es estacionaria en media. 

Por lo que debemos de hacer lo mismo pero con una diferenciacion en la serie de tiempo.
```{r echo=FALSE}
GS_diff<-diff(logGS)
adfTest(diff(train))
```
Como se puede ver el valor de p ahora sí está por debajo de 0.05 por lo que se puede descartar la hipótesis nula de que existan raices unitarias. 

Solo se hizo uso de una diferenciación, por lo que d es 1, pero para conocer p y q se debe de realizar un gráfico de autocorrelación y autocorrelación parcial.
```{r}
acf(logGS,50) 
pacf(logGS,50) 

```


####Linea de tiempo para consumo de gasolina Regular
```{r}
consumoGR_ts <- xts(consumoRegular$cantRegular, consumoRegular$regularDate) 
consumoGR_ts <-ts_ts(consumoGR_ts)
#Saber cuando empieza la serie y cuando termina
start(consumoGR_ts)
end(consumoGR_ts)
#Saber la frecuencia de la serie
frequency(consumoGR_ts)
#Ver el grÃ¡fico de la serie
plot(consumoGR_ts)
```

